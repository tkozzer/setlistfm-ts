name: üîÑ Release Preparation

on:
  push:
    branches: [preview]

jobs:
  release-preparation:
    name: üîÑ Release Preparation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: write
      pull-requests: read

    steps:
      # ------------------------------------------------------------------ #
      #  1.  Setup                                                         #
      # ------------------------------------------------------------------ #
      - name: ‚¨áÔ∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: üì¶ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.11.1

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: pnpm

      - name: üì• Install dependencies
        run: pnpm install --frozen-lockfile

      # ------------------------------------------------------------------ #
      #  2.  Detect version bump                                           #
      # ------------------------------------------------------------------ #
      - name: üè∑Ô∏è Get last release tag
        id: last_release
        shell: bash
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "tag=$LAST_TAG" >> "$GITHUB_OUTPUT"
          echo "Last release tag: $LAST_TAG"

      - name: üìù Collect recent commits
        id: commits
        shell: bash
        run: |
          COMMITS=$(git log "${{ steps.last_release.outputs.tag }}..HEAD" \
                      --max-count=50 --pretty=format:"%h %s%n%b")
          {
            echo "commits<<EOF"
            echo "$COMMITS"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
          echo "Recent commits since ${{ steps.last_release.outputs.tag }}:"
          echo "$COMMITS"

      - name: üîç Determine version bump type
        id: version_bump
        shell: bash
        env:
          RAW_COMMITS: ${{ steps.commits.outputs.commits }}
        run: |
          printf '%s\n' "$RAW_COMMITS" > commits.txt

          if grep -Eq '(^|[\n])BREAKING CHANGE:|!:' commits.txt; then
            BUMP=major
          elif grep -Eq '^[a-f0-9]+ feat(\(|:)' commits.txt; then
            BUMP=minor
          else
            BUMP=patch
          fi

          echo "type=$BUMP" >> "$GITHUB_OUTPUT"
          echo "Version bump ‚áí $BUMP"
          rm commits.txt

      # ------------------------------------------------------------------ #
      #  3.  Bump package.json version                                     #
      # ------------------------------------------------------------------ #
      - name: üìà Update package version
        id: version_update
        shell: bash
        run: |
          CUR=$(node -p "require('./package.json').version")
          echo "Current version: $CUR"

          NEW=$(npm version "${{ steps.version_bump.outputs.type }}" --no-git-tag-version)
          NEW=${NEW#v}

          echo "version=$NEW" >> "$GITHUB_OUTPUT"
          echo "New version: $NEW"

      # ------------------------------------------------------------------ #
      #  4.  Generate changelog with OpenAI                                #
      # ------------------------------------------------------------------ #
      - name: ü§ñ Generate changelog entry with OpenAI
        id: changelog
        shell: bash
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL || 'gpt-4o-mini' }}
          RAW_COMMITS: ${{ steps.commits.outputs.commits }}
        run: |
          set -euo pipefail

          VERSION='${{ steps.version_update.outputs.version }}'
          DATE=$(date +%Y-%m-%d)

          # 4.1  Trim commit text to 12 KB
          printf '%s\n' "$RAW_COMMITS" | head -c 12288 > commits.txt
          COMMITS_CONTENT=$(cat commits.txt)
          rm commits.txt

          # 4.2  Static system prompt (command-substitution form, no indent traps)
          SYSTEM_MSG=$(cat <<'SYS_EOF'
          You are an expert technical writer who creates changelog entries following Keep a Changelog standards. Generate entries that are FOR HUMANS, not machines - focus on what end users and developers need to know. ONLY use these categories: Added, Changed, Deprecated, Removed, Fixed, Security. Be specific about technical impact but NEVER invent features that don't exist. If no meaningful changes are provided, return exactly:

          ### Changed
          - Minor updates and improvements
          SYS_EOF
          )

          # 4.3  Build JSON
          jq -n \
            --arg model   "$OPENAI_MODEL" \
            --arg sys     "$SYSTEM_MSG" \
            --arg version "$VERSION" \
            --arg date    "$DATE" \
            --arg commits "$COMMITS_CONTENT" \
            '{
              model: $model,
              messages: [
                {role:"system", content:$sys},
                {role:"user",
                 content: ("Generate a changelog entry for version " + $version +
                           " with date " + $date + ". Recent commits:\n\n" +
                           $commits + "\n\nIMPORTANT: If the commits list above is empty or " +
                           "contains no meaningful changes, respond with ONLY:\n### Changed\n" +
                           "- Minor updates and improvements\n\n" +
                           "Analyse the commits carefully and write entries that help users " +
                           "understand what changed and how it affects them. This is for the " +
                           "setlistfm-ts TypeScript SDK. Focus on user-facing changes, API " +
                           "modifications, and developer‚Äëexperience improvements. Be accurate " +
                           "and never invent features.") }
              ],
              max_tokens: 1500,
              temperature: 0.3
            }' > prompt.json

          # 4.4  Call OpenAI (fallback on error)
          FALLBACK=$'### Changed\n- Minor updates and improvements\n- Enhanced CI/CD pipeline\n- Updated dependencies and tooling'

          if [[ -z ${OPENAI_API_KEY:-} ]]; then
            echo "No OPENAI_API_KEY ‚Äì using fallback"
            CHANGELOG="$FALLBACK"
          else
            RES=$(curl -sS -w '\n%{http_code}' \
                   -H 'Content-Type: application/json' \
                   -H "Authorization: Bearer $OPENAI_API_KEY" \
                   -d @prompt.json \
                   https://api.openai.com/v1/chat/completions || true)

            CODE=$(echo "$RES" | tail -n1)
            BODY=$(echo "$RES" | head -n -1)

            if [[ $CODE == "200" ]]; then
              CHANGELOG=$(echo "$BODY" | jq -r '.choices[0].message.content // empty')
              [[ -z $CHANGELOG || $CHANGELOG == null ]] && CHANGELOG=$FALLBACK
            else
              echo "OpenAI error ($CODE) ‚Äì using fallback"
              CHANGELOG=$FALLBACK
            fi
          fi

          {
            echo "changelog_entry<<EOF"
            echo "$CHANGELOG"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      # ------------------------------------------------------------------ #
      #  5.  Write CHANGELOG.md                                            #
      # ------------------------------------------------------------------ #
      - name: üìù Update CHANGELOG.md
        shell: bash
        run: |
          VER=${{ steps.version_update.outputs.version }}
          TODAY=$(date +%Y-%m-%d)

          {
            echo "## [$VER] - $TODAY"
            echo
            echo "${{ steps.changelog.outputs.changelog_entry }}"
            echo
            echo '---'
            echo
          } > entry.md

          { head -n 9 CHANGELOG.md; cat entry.md; tail -n +10 CHANGELOG.md; } > CHANGELOG.tmp
          mv CHANGELOG.tmp CHANGELOG.md
          rm entry.md

      # ------------------------------------------------------------------ #
      #  6.  Commit & push                                                 #
      # ------------------------------------------------------------------ #
      - name: üíæ Commit version & changelog updates
        shell: bash
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name  "GitHub Action"
          git add package.json CHANGELOG.md
          git commit -m "chore(release): bump version to ${{ steps.version_update.outputs.version }} and update changelog" \
            || echo "Nothing to commit"
          git push

      # ------------------------------------------------------------------ #
      #  7.  Summary                                                       #
      # ------------------------------------------------------------------ #
      - name: üéâ Release preparation summary
        shell: bash
        run: |
          {
            echo "## üéâ Release Preparation Completed!"
            echo
            echo "üè∑Ô∏è **Version**: ${{ steps.version_update.outputs.version }}"
            echo "üìà **Bump Type**: ${{ steps.version_bump.outputs.type }}"
            echo "üìù **Changelog**: Generated and committed"
            echo
            echo "### üìã Next Steps:"
            echo "1. Review the version bump and changelog entry."
            echo "2. Create PR from preview ‚û°Ô∏è main when ready to publish."
            echo "3. Merge to main will trigger GitHub release and npm publishing."
            echo
            echo "üöÄ **Preview branch is ready for production release!**"
          } >> "$GITHUB_STEP_SUMMARY"
