# .github/workflows/ci.yml
name: ðŸ”„ CI

on:
  pull_request:
    branches: [preview, main]
  schedule:
    - cron: "0 2 * * *" # nightly at 02 UTC

# Cancel stale runs on PRs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# ##############################################################################
#  ðŸš€ Quick checks â€“ lint, typeâ€‘check, fast unit tests (Node 22, Linux)
# ##############################################################################
jobs:
  quick-checks:
    name: ðŸš€ Quick Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v4

      # Reâ€‘use the central â€œsetup Node & pnpmâ€ workflow
      - uses: .github/workflows/.reuse/setup-node-pnpm.yml
        with:
          node-version: 22.x

      # Fast sanity checks
      - run: pnpm lint
      - run: pnpm type-check
      - run: pnpm vitest run src/

  # ##############################################################################
  #  ðŸ§ª Test matrix â€“ multiâ€‘OS / multiâ€‘Node
  # ##############################################################################
  test-matrix:
    name: ðŸ§ª Test (${{ matrix.node }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    needs: quick-checks

    strategy:
      fail-fast: false
      matrix:
        node: [18.x, 20.x, 22.x]
        os: [ubuntu-latest, windows-latest, macos-latest]
        exclude:
          - os: windows-latest
            node: 18.x
          - os: macos-latest
            node: 18.x

    steps:
      - uses: actions/checkout@v4
      - uses: .github/workflows/.reuse/setup-node-pnpm.yml
        with:
          node-version: ${{ matrix.node }}

      - run: pnpm vitest run src/
      - run: pnpm type-check

  # ##############################################################################
  #  ðŸ“Š Coverage job (Node 22, Linux)
  # ##############################################################################
  coverage:
    name: ðŸ“Š Coverage & Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: quick-checks

    steps:
      - uses: actions/checkout@v4
      - uses: .github/workflows/.reuse/setup-node-pnpm.yml
        with:
          node-version: 22.x

      # Emit a JSON summary so the followâ€‘up step never 404s
      - run: pnpm vitest run --coverage --coverage.reporter=json-summary src/

      - uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 30

      - name: ðŸ“Š Coverage Summary
        run: |
          echo '## ðŸ“Š Coverage Summary' >> "$GITHUB_STEP_SUMMARY"
          echo 'Reports uploaded as artifact.' >> "$GITHUB_STEP_SUMMARY"
          if [ -f coverage/coverage-summary.json ]; then
            echo '```json' >> "$GITHUB_STEP_SUMMARY"
            cat coverage/coverage-summary.json >> "$GITHUB_STEP_SUMMARY"
            echo '```' >> "$GITHUB_STEP_SUMMARY"
          fi

  # ##############################################################################
  #  ðŸ—ï¸ Build verification (Node 22, Linux)
  # ##############################################################################
  build-verification:
    name: ðŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: quick-checks

    steps:
      - uses: actions/checkout@v4
      - uses: .github/workflows/.reuse/setup-node-pnpm.yml
        with:
          node-version: 22.x

      - run: pnpm build:all
      - run: pnpm vitest run tests/
      - run: pnpm build:analyze

      - uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

      - name: ðŸ—ï¸ Build Summary
        run: |
          echo '## ðŸ—ï¸ Build Summary' >> "$GITHUB_STEP_SUMMARY"
          ls -la dist/               >> "$GITHUB_STEP_SUMMARY"

  # ##############################################################################
  #  âœ… Success gate â€“ block merge if any job failed
  # ##############################################################################
  ci-success:
    name: âœ… CI Success
    runs-on: ubuntu-latest
    if: always()
    needs:
      - quick-checks
      - test-matrix
      - coverage
      - build-verification

    steps:
      - name: Final status check
        run: |
          for job in quick-checks test-matrix coverage build-verification; do
            result="${{ needs[job].result }}"
            [ "$result" != success ] && { echo "âŒ $job failed"; exit 1; }
          done
          echo 'âœ… All CI jobs completed successfully!' > "$GITHUB_STEP_SUMMARY"
